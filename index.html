<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>India Map – Dams & Boundaries</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.29/"></script>

<style>
  html, body, #viewDiv {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  input[type="text"], select {
    box-sizing: border-box;
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  #controls {
    position: absolute;
    top: 12px;
    left: 12px;
    background: white;
    padding: 14px;
    z-index: 99;
    font-family: Arial, sans-serif;
    font-size: 13px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    width: 340px;
    border-radius: 10px;
  }

  .section { font-weight: bold; margin-top: 10px; }

  #results {
    max-height: 160px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 6px;
    display: none;
  }

  .result-item {
    padding: 6px;
    cursor: pointer;
  }
  .result-item:hover {
    background: #e6e6e6;
  }
</style>
</head>

<body>

<div id="controls">

  <div class="section">Search Dam</div>
  <input type="text" id="damSearch" placeholder="Type dam name…" />
  <div id="results"></div>

  <div class="section">Basemap</div>
  <select id="basemapSelect">
    <option value="satellite" selected>Satellite</option>
    <option value="streets">Street</option>
    <option value="topo">Topographic</option>
    <option value="none">No basemap</option>
  </select>

  <div class="section">Layers</div>
  <label><input type="checkbox" id="stateChk" checked> State Boundary</label><br>
  <label><input type="checkbox" id="districtChk"> District Boundary</label><br>
  <label><input type="checkbox" id="riverChk"> River</label><br>
  <label><input type="checkbox" id="watershedChk"> Watershed</label><br>
  <label><input type="checkbox" id="damChk" checked> Dams & Labels</label>

</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/MapImageLayer",
  "esri/layers/FeatureLayer",
  "esri/geometry/Point",
  "esri/config"
], function (
  Map, MapView,
  MapImageLayer, FeatureLayer,
  Point, esriConfig
) {

  // ───────────── BharatMap token interceptor ─────────────
  esriConfig.request.interceptors.push({
    urls: /mapservice\.gov\.in/,
    before: p => {
      p.requestOptions.query = p.requestOptions.query || {};
      const u = p.url;
      if (u.includes("State_Boundary"))
        p.requestOptions.query.token = "B_MvXZQQA3UJQ3rriTr7Qvo4AE-8f2v0JmAgH3h17-3OVcp7agXot9jS8Q7ZPelzaaShzPs5CR7tqOeucn4Oww..";
      else if (u.includes("District_Boundary"))
        p.requestOptions.query.token = "KLafX5W7tKxU3qXCTtWzmiub5IsvSYcYf8OYVbFZaO_5Dlji_67_mzrUu6qCgWJ6djeLy_izw-rxbEWms3Ss0g..";
      else if (u.includes("River"))
        p.requestOptions.query.token = "aprsZsvhLhQlrHeo2O-9F-PWMUmaTr7awaxuyKOXtWOMMp0VVG70sfDnNltnsh3SLOqcK8zLNCvPqBThYxn5tw..";
      else if (u.includes("Watershed"))
        p.requestOptions.query.token = "LYFmEZL-IKy3-iAuFBbGMpNs0rPaWFMD5KuaJUT7I6OFXUWRxnUhDjR3SJfE-ndgh9aAdyua9Cs8b9POB7R51Q..";
    }
  });

  // ───────────── Boundary layers ─────────────
  const stateLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer",
    visible: true
  });

  const districtLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/District_Boundary/MapServer",
    visible: false
  });

  const riverLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/River/MapServer",
    visible: false
  });

  const watershedLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/Watershed/MapServer",
    visible: false
  });

  const map = new Map({
    basemap: "satellite",
    layers: [stateLayer, districtLayer, riverLayer, watershedLayer]
  });

  const view = new MapView({
    container: "viewDiv",
    map,
    extent: {
      xmin: 68, ymin: 6,
      xmax: 97, ymax: 37,
      spatialReference: { wkid: 4326 }
    },
    popup: {
      dockEnabled: true,
      dockOptions: { position: "top-right", breakpoint: false }
    }
  });

  basemapSelect.onchange = () => {
    map.basemap =
      basemapSelect.value === "none" ? null :
      basemapSelect.value === "streets" ? "streets-vector" :
      basemapSelect.value === "topo" ? "topo-vector" :
      "satellite";
  };

  stateChk.onchange = () => stateLayer.visible = stateChk.checked;
  districtChk.onchange = () => districtLayer.visible = districtChk.checked;
  riverChk.onchange = () => riverLayer.visible = riverChk.checked;
  watershedChk.onchange = () => watershedLayer.visible = watershedChk.checked;

  function dmsToDecimal(dms) {
    const p = dms?.match(/\d+/g);
    return p ? (+p[0] + p[1]/60 + (p[2]||0)/3600) : null;
  }

  fetch("dams.json")
    .then(r => r.json())
    .then(json => {

      const features = [];

      json.data.forEach((dam, i) => {
        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        features.push({
          geometry: new Point({ latitude: lat, longitude: lon }),
          attributes: {
            OBJECTID: i + 1,
            Name_of_Dam: dam.Name_of_Dam || "Unknown",
            ...dam
          }
        });
      });

      const damLayer = new FeatureLayer({
        source: features,
        objectIdField: "OBJECTID",
        geometryType: "point",
        spatialReference: { wkid: 4326 },

        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            size: 6,
            color: [0,102,204,0.9],
            outline: null
          }
        },

        // ───────── SCALE-DEPENDENT LABELING (ONLY CHANGE) ─────────
        labelingInfo: [

          {
            where: `"Gross Storage Capacity(mcm)" >= 500`,
            labelExpressionInfo: { expression: "$feature.Name_of_Dam" },
            symbol: {
              type: "text",
              color: [255,165,0],
              haloColor: [0,0,0,0.8],
              haloSize: "1.2px",
              font: { size: 9, weight: "bold" }
            },
            labelPlacement: "above-center",
            minScale: 0,
            maxScale: 0
          },

          {
            where: `"Gross Storage Capacity(mcm)" < 500`,
            labelExpressionInfo: { expression: "$feature.Name_of_Dam" },
            symbol: {
              type: "text",
              color: [255,215,0],
              haloColor: [0,0,0,0.7],
              haloSize: "1px",
              font: { size: 8 }
            },
            labelPlacement: "above-center",
            maxScale: 1000000
          }
        ],

        popupTemplate: {
          title: "{Name_of_Dam}",
          content: function (feature) {
            const a = feature.graphic.attributes;
            let html = "<table style='width:100%'>";
            for (const k in a) {
              if (k === "OBJECTID") continue;
              html += `<tr>
                <td style="font-weight:bold;padding:4px">${k}</td>
                <td style="padding:4px">${a[k] ?? "-"}</td>
              </tr>`;
            }
            return html + "</table>";
          }
        }
      });

      map.add(damLayer);
      damChk.onchange = () => damLayer.visible = damChk.checked;

      damSearch.oninput = function () {
        const q = this.value.toLowerCase();
        results.innerHTML = "";
        results.style.display = "none";
        if (!q) return;

        damLayer.queryFeatures({
          where: `LOWER(Name_of_Dam) LIKE '%${q.replace(/'/g,"''")}%'`,
          returnGeometry: true,
          outFields: ["*"],
          num: 50
        }).then(r => {
          if (!r.features.length) return;
          results.style.display = "block";
          r.features.forEach(f => {
            const div = document.createElement("div");
            div.className = "result-item";
            div.textContent = f.attributes.Name_of_Dam;
            div.onclick = () => {
              results.style.display = "none";
              view.goTo({ target: f.geometry, zoom: 11 })
                .then(() => view.popup.open({ features: [f] }));
            };
            results.appendChild(div);
          });
        });
      };
    });
});
</script>

</body>
</html>
