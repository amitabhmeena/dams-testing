<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>India Map – Dams & Boundaries</title>

<!-- ============================================================
     ArcGIS JavaScript API (v4.29)
     ============================================================ -->
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.29/"></script>

<style>
/* ============================================================
   BASIC PAGE + MAP CONTAINER
   ============================================================ */
html, body, #viewDiv {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
}

/* ============================================================
   FORM ELEMENTS
   ============================================================ */
input[type="text"], select {
  box-sizing: border-box;
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

/* ============================================================
   FLOATING CONTROL PANEL
   ============================================================ */
#controls {
  position: absolute;
  top: 12px;
  left: 12px;
  background: white;
  padding: 14px;
  z-index: 99;
  font-family: Arial, sans-serif;
  font-size: 13px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  width: 340px;
  border-radius: 10px;
  transition: all 0.3s ease;
}

/* Collapsed state (mobile / iOS) */
#controls.collapsed #toggle-container {
  max-height: 0;
  opacity: 0;
  overflow: hidden;
}

/* Section headings */
.section {
  font-weight: bold;
  margin-top: 10px;
}

/* ============================================================
   SEARCH RESULTS LIST
   ============================================================ */
#results {
  max-height: 160px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
  display: none;
}

.result-item {
  padding: 6px;
  cursor: pointer;
}

.result-item:hover,
.result-item.active {
  background: #e6e6e6;
}

/* ============================================================
   SEARCH INPUT + CLEAR BUTTON
   ============================================================ */
.search-wrap {
  position: relative;
}

#clearSearch {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: transparent;
  font-size: 18px;
  cursor: pointer;
  display: none;
}

/* ============================================================
   RESPONSIVE ADJUSTMENT
   ============================================================ */
@media (max-width: 768px) {
  #controls {
    width: 92%;
    left: 4%;
  }
}
</style>
</head>

<body>

<!-- ============================================================
     CONTROL PANEL (SEARCH + TOGGLES)
     ============================================================ -->
<div id="controls">

  <!-- ================= SEARCH ================= -->
  <div id="search-container">
    <div class="section">Search Dam</div>
    <div class="search-wrap">
      <input type="text" id="damSearch" placeholder="Type dam name…" />
      <button id="clearSearch" title="Clear">×</button>
    </div>
    <div id="results"></div>
  </div>

  <!-- ================= TOGGLES ================= -->
  <div id="toggle-container">

    <div class="section">Basemap</div>
    <select id="basemapSelect">
      <option value="satellite" selected>Satellite</option>
      <option value="streets">Street</option>
      <option value="topo">Topographic</option>
      <option value="none">No basemap</option>
    </select>

    <div class="section">Layers</div>
    <label><input type="checkbox" id="stateChk" checked> State Boundary</label><br>
    <label><input type="checkbox" id="districtChk"> District Boundary</label><br>
    <label><input type="checkbox" id="riverChk"> River</label><br>
    <label><input type="checkbox" id="watershedChk"> Watershed</label><br>
    <label><input type="checkbox" id="damChk" checked> Dams & Labels</label>

  </div>
</div>

<!-- ============================================================
     MAP VIEW CONTAINER
     ============================================================ -->
<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/MapImageLayer",
  "esri/layers/FeatureLayer",
  "esri/Graphic",
  "esri/geometry/Point",
  "esri/config"
], function (
  Map, MapView,
  MapImageLayer, FeatureLayer,
  Graphic, Point, esriConfig
) {

  /* ============================================================
     DEVICE DETECTION (FOR AUTO-COLLAPSE)
     ============================================================ */
  const isMobile = window.matchMedia("(max-width: 768px)").matches;
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const controls = document.getElementById("controls");

  function collapse() {
    if (isMobile || isIOS) controls.classList.add("collapsed");
  }
  function expand() {
    if (isMobile || isIOS) controls.classList.remove("collapsed");
  }

  /* ============================================================
     TOKEN INJECTION FOR MAPSERVICE.GOV.IN
     (CRITICAL FOR AUTHENTICATION)
     ============================================================ */
  esriConfig.request.interceptors.push({
    urls: /mapservice\.gov\.in/,
    before: p => {
      p.requestOptions.query = p.requestOptions.query || {};
      const u = p.url;

      if (u.includes("State_Boundary"))
        p.requestOptions.query.token =
          "B_MvXZQQA3UJQ3rriTr7Qvo4AE-8f2v0JmAgH3h17-3OVcp7agXot9jS8Q7ZPelzaaShzPs5CR7tqOeucn4Oww..";

      else if (u.includes("District_Boundary"))
        p.requestOptions.query.token =
          "KLafX5W7tKxU3qXCTtWzmiub5IsvSYcYf8OYVbFZaO_5Dlji_67_mzrUu6qCgWJ6djeLy_izw-rxbEWms3Ss0g..";

      else if (u.includes("River"))
        p.requestOptions.query.token =
          "aprsZsvhLhQlrHeo2O-9F-PWMUmaTr7awaxuyKOXtWOMMp0VVG70sfDnNltnsh3SLOqcK8zLNCvPqBThYxn5tw..";

      else if (u.includes("Watershed"))
        p.requestOptions.query.token =
          "LYFmEZL-IKy3-iAuFBbGMpNs0rPaWFMD5KuaJUT7I6OFXUWRxnUhDjR3SJfE-ndgh9aAdyua9Cs8b9POB7R51Q..";
    }
  });

  /* ============================================================
     BOUNDARY LAYERS (MAP IMAGE SERVICES)
     ============================================================ */
  const stateLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer",
    visible: true
  });

  const districtLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/District_Boundary/MapServer",
    visible: false
  });

  const riverLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/River/MapServer",
    visible: false
  });

  const watershedLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/Watershed/MapServer",
    visible: false
  });

  /* ============================================================
     MAP + VIEW INITIALIZATION
     ============================================================ */
  const map = new Map({
    basemap: "satellite",
    layers: [stateLayer, districtLayer, riverLayer, watershedLayer]
  });

  const view = new MapView({
    container: "viewDiv",
    map,
    extent: {
      xmin: 68,
      ymin: 6,
      xmax: 97,
      ymax: 37,
      spatialReference: { wkid: 4326 }
    },
    popup: {
      dockEnabled: true,
      dockOptions: {
        position: "top-right",
        breakpoint: false
      }
    }
  });

  /* Auto-collapse controls when map is used */
  view.on("drag", collapse);
  view.on("mouse-wheel", collapse);
  view.on("click", collapse);
  view.on("pointer-down", collapse);
  view.on("touchstart", collapse);
  damSearch.addEventListener("focus", expand);

  /* ============================================================
     BASEMAP SWITCHING (INCLUDING NO BASEMAP)
     ============================================================ */
  basemapSelect.onchange = () => {
    map.basemap =
      basemapSelect.value === "none" ? null :
      basemapSelect.value === "satellite" ? "satellite" :
      basemapSelect.value === "streets" ? "streets-vector" :
      "topo-vector";
  };

  /* ============================================================
     LAYER VISIBILITY TOGGLES
     ============================================================ */
  stateChk.onchange = () => stateLayer.visible = stateChk.checked;
  districtChk.onchange = () => districtLayer.visible = districtChk.checked;
  riverChk.onchange = () => riverLayer.visible = riverChk.checked;
  watershedChk.onchange = () => watershedLayer.visible = watershedChk.checked;

  /* ============================================================
     HELPER: DMS → DECIMAL DEGREES
     ============================================================ */
  function dmsToDecimal(dms) {
    const p = dms?.match(/\d+/g);
    return p ? (+p[0] + p[1] / 60 + (p[2] || 0) / 3600) : null;
  }

  /* ============================================================
     LOAD DAMS.JSON → CREATE FEATURELAYER
     ============================================================ */
  let damFeatureLayer;

  fetch("dams.json")
    .then(r => r.json())
    .then(json => {

      const features = [];

      json.data.forEach((dam, index) => {
        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        features.push({
          geometry: new Point({
            latitude: lat,
            longitude: lon,
            spatialReference: { wkid: 4326 }
          }),
          attributes: {
            OBJECTID: index + 1,
            Name_of_Dam: dam.Name_of_Dam || "Unknown",
            ...dam
          }
        });
      });

      /* ================= RENDERER ================= */
      const renderer = {
        type: "simple",
        symbol: {
          type: "simple-marker",
          color: [0, 102, 204, 0.9],
          size: 6,
          outline: null
        },
        visualVariables: [{
          type: "size",
          field: "Gross Storage Capacity(mcm)",
          stops: [
            { value: 0, size: 4 },
            { value: 500, size: 12 }
          ]
        }]
      };

      /* ================= LABELING ================= */
      const labelingInfo = [{
        labelExpressionInfo: { expression: "$feature.Name_of_Dam" },
        symbol: {
          type: "text",
          color: [255, 165, 0],
          haloColor: [0, 0, 0, 0.8],
          haloSize: "1.2px",
          font: {
            size: 8,
            family: "Arial",
            weight: "bold"
          },
          yoffset: 8
        },
        labelPlacement: "above-center",
        minScale: 0,
        maxScale: 0
      }];

      /* ================= FEATURELAYER ================= */
      damFeatureLayer = new FeatureLayer({
        source: features,
        objectIdField: "OBJECTID",
        geometryType: "point",
        spatialReference: { wkid: 4326 },
        fields: [
          { name: "OBJECTID", type: "oid" },
          { name: "Name_of_Dam", type: "string" }
        ],
        renderer,
        labelingInfo,
        popupTemplate: {
  title: "{Name_of_Dam}",
  content: function (feature) {
    const attrs = feature.graphic.attributes;
    let html = "<table style='width:100%; border-collapse:collapse;'>";

    for (const key in attrs) {
      if (key === "OBJECTID") continue;
      html += `
        <tr>
          <td style="padding:4px; font-weight:bold; border-bottom:1px solid #ddd;">
            ${key}
          </td>
          <td style="padding:4px; border-bottom:1px solid #ddd;">
            ${attrs[key] ?? "-"}
          </td>
        </tr>`;
    }

    html += "</table>";
    return html;
  }
}

      });

      map.add(damFeatureLayer);
      damChk.onchange = () => damFeatureLayer.visible = damChk.checked;
    });

});
</script>
</body>
</html>
