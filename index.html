<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>India Map – Dams & Boundaries</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body, #viewDiv { margin:0; padding:0; height:100%; width:100%; }
    #controls { position:absolute; top:12px; left:12px; background:white; padding:14px; z-index:99; font-family:Arial,sans-serif; font-size:13px; box-shadow:0 3px 8px rgba(0,0,0,0.3); width:340px; border-radius:10px; }
    .section { font-weight:bold; margin-top:10px; }
    input[type="text"], select { box-sizing:border-box; width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; }
    #results { max-height:180px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; display:none; margin-top:8px; }
    .result-item { padding:6px; cursor:pointer; }
    .result-item:hover, .result-item.active { background:#e6e6e6; }
    .search-wrap { position:relative; }
    #clearSearch { position:absolute; right:8px; top:50%; transform:translateY(-50%); border:none; background:transparent; font-size:18px; cursor:pointer; display:none; }
    @media (max-width:768px) { #controls { width:92%; left:4%; } }
  </style>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-58510VNE1R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-58510VNE1R', { anonymize_ip: true });
  </script>
</head>
<body>
  <div id="controls">
    <div class="search-wrap">
      <input type="text" id="damSearch" placeholder="Type dam name…" />
      <button id="clearSearch">×</button>
    </div>
    <div id="results"></div>

    <div class="section">Basemap</div>
    <select id="basemapSelect">
      <option value="satellite" selected>Satellite</option>
      <option value="streets">Streets</option>
      <option value="topo">Topographic</option>
      <option value="none">No basemap</option>
    </select>

    <div class="section">Layers</div>
    <label><input type="checkbox" id="stateChk" checked> State Boundary</label><br>
    <label><input type="checkbox" id="districtChk"> District Boundary</label><br>
    <label><input type="checkbox" id="riverChk"> River</label><br>
    <label><input type="checkbox" id="watershedChk"> Watershed</label><br>
    <label><input type="checkbox" id="damChk" checked> Dams</label>
  </div>

  <div id="viewDiv"></div>

  <script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/MapImageLayer",
    "esri/layers/FeatureLayer",
    "esri/layers/support/LabelClass",
    "esri/renderers/ClassBreaksRenderer",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/symbols/TextSymbol",
    "esri/PopupTemplate",
    "esri/Basemap"
  ], (Map, MapView, MapImageLayer, FeatureLayer, LabelClass, ClassBreaksRenderer, SimpleMarkerSymbol, TextSymbol, PopupTemplate, Basemap) => {

    const map = new Map({
      basemap: "satellite",
      spatialReference: { wkid: 4326 }
    });

    const view = new MapView({
      container: "viewDiv",
      map: map,
      extent: { xmin: 68, ymin: 6, xmax: 97, ymax: 37, spatialReference: { wkid: 4326 } },
      popup: { dockEnabled: true, dockOptions: { position: "top-right", breakpoint: false } }
    });

    // BharatMap layers with your tokens (unchanged)
    const stateLayer = new MapImageLayer({ url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer", visible: true });
    const districtLayer = new MapImageLayer({ url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/District_Boundary/MapServer", visible: false });
    const riverLayer = new MapImageLayer({ url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/River/MapServer", visible: false });
    const watershedLayer = new MapImageLayer({ url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/Watershed/MapServer", visible: false });

    map.addMany([stateLayer, districtLayer, riverLayer, watershedLayer]);

    // Layer toggles
    document.getElementById("stateChk").addEventListener("change", e => stateLayer.visible = e.target.checked);
    document.getElementById("districtChk").addEventListener("change", e => districtLayer.visible = e.target.checked);
    document.getElementById("riverChk").addEventListener("change", e => riverLayer.visible = e.target.checked);
    document.getElementById("watershedChk").addEventListener("change", e => watershedLayer.visible = e.target.checked);

    // Basemap switch with refresh
    document.getElementById("basemapSelect").addEventListener("change", e => {
      const val = e.target.value;
      if (val === "none") {
        map.basemap = new Basemap({ baseLayers: [] });
      } else {
        map.basemap = val === "satellite" ? "satellite" :
                      val === "streets" ? "streets-vector" : "topo-vector";
      }
      setTimeout(() => view.refresh(), 400); // Give time for basemap to unload
    });

    // Load dams from your raw GitHub JSON
    fetch("https://raw.githubusercontent.com/amitabhmeena/dams-testing/main/dams.json")
      .then(r => r.json())
      .then(json => {
        const graphics = [];
        let oid = 1;
        json.data.forEach(dam => {
          const lat = dmsToDecimal(dam.Latitude);
          const lon = dmsToDecimal(dam.Longitude);
          if (!lat || !lon) return;

          const storage = Number(dam["Gross Storage Capacity(mcm)"] || 0);

          const attrs = { ...dam, ObjectID: oid++, GrossStorageCapacityMcm: storage };
          const g = { geometry: { type: "point", longitude: lon, latitude: lat }, attributes: attrs };
          graphics.push(g);
        });

        if (graphics.length === 0) {
          console.warn("No valid dam points loaded");
          return;
        }

        // Dynamic fields (based on first dam)
        const first = json.data[0];
        const fields = [{ name: "ObjectID", alias: "ObjectID", type: "oid" }];
        Object.keys(first).forEach(k => {
          fields.push({
            name: k.replace(/[^a-zA-Z0-9_]/g, '_'), // Clean field names
            alias: k,
            type: typeof first[k] === 'number' ? 'double' : 'string'
          });
        });

        // Renderer: size based on capacity
        const renderer = new ClassBreaksRenderer({
          field: "GrossStorageCapacityMcm",
          classBreakInfos: [
            { minValue: -Infinity, maxValue: 499.999, symbol: new SimpleMarkerSymbol({ color: [0,102,204,0.9], size: 4 }) },
            { minValue: 500, maxValue: Infinity, symbol: new SimpleMarkerSymbol({ color: [0,102,204,0.9], size: 8 }) }
          ]
        });

        // Popup
        const popupTemplate = new PopupTemplate({
          title: "{Name_of_Dam}",
          content: fields.slice(1).map(f => ({ type: "fields", fieldInfos: [{ fieldName: f.name, label: f.alias }] }))
        });

        // Labels: simple first (to test visibility), then multiline
        const labelSymbol = new TextSymbol({
          color: "orange",
          haloColor: "black",
          haloSize: 1,
          font: { size: 8, family: "Arial", weight: "bold" },
          yoffset: 8
        });

        const labelExpression = "$feature.Name_of_Dam"; // Simple version first – change to multiline if needed

        const labelClass = new LabelClass({
          symbol: labelSymbol,
          labelExpressionInfo: { expression: labelExpression }
        });

        const damLayer = new FeatureLayer({
          source: graphics,
          objectIdField: "ObjectID",
          fields: fields,
          geometryType: "point",
          spatialReference: { wkid: 4326 },
          renderer: renderer,
          popupTemplate: popupTemplate,
          labelingInfo: [labelClass], // Native labeling!
          visible: true
        });

        map.add(damLayer);

        // Dam toggle
        document.getElementById("damChk").addEventListener("change", e => damLayer.visible = e.target.checked);

        // Force labels visible (and refresh on zoom/basemap)
        damLayer.labelsVisible = true;
        view.watch("zoom", () => view.refresh());
      })
      .catch(err => console.error("Dams load error:", err));

    // DMS to decimal (unchanged)
    function dmsToDecimal(dms) {
      const p = dms?.match(/\d+/g);
      return p ? (+p[0] + p[1]/60 + (p[2]||0)/3600) : null;
    }

    // Search (client-side)
    const damSearch = document.getElementById("damSearch");
    const results = document.getElementById("results");
    const clearSearch = document.getElementById("clearSearch");
    let currentMatches = [];

    damSearch.addEventListener("input", () => {
      const q = damSearch.value.trim().toLowerCase();
      results.innerHTML = "";
      results.style.display = "none";
      clearSearch.style.display = q ? "block" : "none";
      if (!q) return;

      currentMatches = damLayer.source.items
        .filter(g => g.attributes.Name_of_Dam?.toLowerCase().includes(q))
        .slice(0, 50);

      if (!currentMatches.length) return;
      results.style.display = "block";

      currentMatches.forEach((g, i) => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.textContent = g.attributes.Name_of_Dam;
        div.onclick = () => {
          results.style.display = "none";
          damSearch.value = g.attributes.Name_of_Dam;
          view.goTo({ target: g.geometry, zoom: 12 });
          view.popup.open({ features: [g] });
        };
        results.appendChild(div);
      });
    });

    clearSearch.onclick = () => {
      damSearch.value = "";
      results.style.display = "none";
      clearSearch.style.display = "none";
      view.popup.close();
    };
  });
  </script>
</body>
</html>
