<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>India Map â€“ Dams & Boundaries</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.29/"></script>

<style>
html, body, #viewDiv {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
}

#controls {
  position: absolute;
  top: 12px;
  left: 12px;
  background: white;
  padding: 14px;
  z-index: 99;
  width: 340px;
  border-radius: 10px;
  font-family: Arial, sans-serif;
  font-size: 13px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

.section {
  font-weight: bold;
  margin-top: 10px;
}

input, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

#results {
  max-height: 160px;
  overflow-y: auto;
  border: 1px solid #ccc;
  display: none;
}

.result-item {
  padding: 6px;
  cursor: pointer;
}

.result-item:hover {
  background: #e6e6e6;
}
</style>
</head>

<body>

<div id="controls">
  <div class="section">Search Dam</div>
  <input id="damSearch" placeholder="Type dam nameâ€¦" />
  <div id="results"></div>

  <div class="section">Basemap</div>
  <select id="basemapSelect">
    <option value="satellite" selected>Satellite</option>
    <option value="streets">Streets</option>
    <option value="topo">Topographic</option>
    <option value="none">No basemap</option>
  </select>
</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/geometry/Point"
], function(Map, MapView, FeatureLayer, Point) {

  const map = new Map({ basemap: "satellite" });

  const view = new MapView({
    container: "viewDiv",
    map,
    extent: { xmin: 68, ymin: 6, xmax: 97, ymax: 37, spatialReference: { wkid: 4326 } },
    popup: {
      dockEnabled: true,
      dockOptions: { position: "top-right", breakpoint: false }
    }
  });

  basemapSelect.onchange = () => {
    map.basemap =
      basemapSelect.value === "none" ? null :
      basemapSelect.value === "streets" ? "streets-vector" :
      basemapSelect.value === "topo" ? "topo-vector" :
      "satellite";
  };

  function dmsToDecimal(dms) {
    const p = dms?.match(/\d+/g);
    return p ? (+p[0] + p[1]/60 + (p[2]||0)/3600) : null;
  }

  let damLayer;

  fetch("dams.json")
    .then(r => r.json())
    .then(json => {

      const features = [];

      json.data.forEach((dam, i) => {
        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        features.push({
          geometry: new Point({ latitude: lat, longitude: lon }),
          attributes: {
            OBJECTID: i + 1,
            ...dam,
            Name_of_Dam: dam.Name_of_Dam || "Unknown"
          }
        });
      });

      /* ðŸ”‘ AUTO-GENERATE FIELD DEFINITIONS */
      const sample = features[0].attributes;
      const fields = Object.keys(sample).map(k => ({
        name: k,
        alias: k.replace(/_/g, " "),
        type: k === "OBJECTID" ? "oid" :
              typeof sample[k] === "number" ? "double" : "string"
      }));

      damLayer = new FeatureLayer({
        source: features,
        objectIdField: "OBJECTID",
        geometryType: "point",
        spatialReference: { wkid: 4326 },
        fields: fields,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            size: 6,
            color: [0, 102, 204, 0.9]
          }
        },
        labelingInfo: [{
          labelExpressionInfo: { expression: "$feature.Name_of_Dam" },
          symbol: {
            type: "text",
            color: "orange",
            haloColor: "black",
            haloSize: "1px",
            font: { size: 8, weight: "bold" }
          },
          labelPlacement: "above-center"
        }],
        popupTemplate: {
          title: "{Name_of_Dam}",
          content: [{
            type: "fields",
            fieldInfos: fields
              .filter(f => f.name !== "OBJECTID")
              .map(f => ({ fieldName: f.name, label: f.alias }))
          }]
        }
      });

      map.add(damLayer);

      /* SEARCH */
      damSearch.oninput = function() {
        const q = this.value.toLowerCase();
        results.innerHTML = "";
        results.style.display = "none";
        if (!q) return;

        damLayer.queryFeatures({
          where: `LOWER(Name_of_Dam) LIKE '%${q.replace(/'/g,"''")}%'`,
          returnGeometry: true,
          outFields: ["*"],
          num: 50
        }).then(r => {
          if (!r.features.length) return;
          results.style.display = "block";

          r.features.forEach(f => {
            const d = document.createElement("div");
            d.className = "result-item";
            d.textContent = f.attributes.Name_of_Dam;
            d.onclick = () => {
              view.goTo({ target: f.geometry, zoom: 11 });
              view.popup.open({ features: [f], location: f.geometry });
              results.style.display = "none";
            };
            results.appendChild(d);
          });
        });
      };

    })
    .catch(err => console.error("Failed to load dams.json", err));
});
</script>

</body>
</html>
